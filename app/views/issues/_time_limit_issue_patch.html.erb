<%= javascript_include_tag('redmine_time_limit.js', :plugin => 'redmine_time_limit') %>

<% unless TimeEntry.have_permissions?(User.current, @project) %>
  <% include_time_limit_js = true %>
  <%= time_limit_protected_statuses_div %>

  <%= javascript_tag do %>
    hideShowLogTimeIconIfProtected();

    $(document.body).ready(function() {
      // call this function twice: in loading process and after document ready
      // first calling to avoid displaying/blinking 'Log time' at top
      // second one to hide 'Log time' at bottom
      hideShowLogTimeIconIfProtected();
      if ($('#issue_status_id')) {
        showHideLogTimeFieldset();
        $(document).on('change', '#issue_status_id', showHideLogTimeFieldset);
      }
    })
  <% end %>
<% end %>

<% if (start = @issue.timer_can_be_started?(User.current)) || (stop = @issue.timer_can_be_stopped?(User.current)) %>
  <% link = if start
              link_to(t('tl_start_timer'), start_timer_path(@issue))
            elsif stop
              link_to(t('tl_stop_timer'), stop_timer_path(@issue))
            end %>

  <% include_time_limit_js = true %>
  <%= javascript_tag do %>
    $('#main #content .contextual').first().prepend('<%= link %>')
  <% end %>
<% end %>
